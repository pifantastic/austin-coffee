<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Austin Coffee Shops</title>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/brew.css">
  </head>
  <body>
    <header>
      <h1>Austin Coffee Shops</h1>
    </header>
    <section id="controls"></section>
    <section id="radar"></section>
    <footer>
      <h3>Am I missing one?  Want to leave your own feedback?</h3>
      <a href="https://docs.google.com/spreadsheet/viewform?formkey=dE9wdU9nT0xLTE8wVm15RFVGRTUxZXc6MQ">Click here!</a>
    </footer>
    <script src="js/jquery.js"></script>
    <script src="js/d3.js"></script>
    <script src="js/d3.geom.js"></script>
    <script>
      var url = "https://spreadsheets.google.com/feeds/list/tOpuOgOLKLO0VmyDUFE51ew/od6/public/values?alt=json-in-script&callback=listEntries"

      function buildControls(data) {
        var controls = $('#controls');

        $.each(data, function(id, shop) {
          var checkbox = $('<input type="checkbox" checked="checked"/>')
            .change(function() {
              $('#' + id).toggle($(this).is(':checked'));
            })

          var swatch = $('<span class="swatch" />')
            .css({ backgroundColor: shop.color })

          var link = $('<a />')
            .attr('href', shop.link)
            .text(shop.link)

          $('<label />')
            .text(shop.name + ' | ')
            .prepend(checkbox)
            .prepend(swatch)
            .append(link)
            .appendTo(controls)
        });
      }

      function buildGraph(data) {
        var width = 600
        var height = 400
        var scale = 5
        var points = 5
        var labels = ['taste', 'price', 'wifi', 'hours', 'ambiance']

        var svg = d3.select("#radar")
          .append("svg:svg")
            .attr("width", width)
            .attr("height", height)

        var originX = Math.floor(width / 2)
        var originY = Math.floor(height / 2)
        var radius = Math.floor((width > height ? height : width) / 2)

        // Render data.
        $.each(data, function(id, data) {
          var coords = []
            , shop = svg.append('svg:g').attr("id", id);

          $.each(labels, function(i, attr) {
            var r = Math.round(radius / scale) * data.data[attr]
              , a = (Math.round(360 / labels.length) * i) * (Math.PI / 180)
              , x = Math.round(originX + r * Math.cos(a))
              , y = Math.round(originY + r * Math.sin(a))
            coords.push([x, y].join(','))

            shop.append('svg:circle')
              .attr("class", "dot")
              .attr("cx", x)
              .attr("cy", y)
              .attr("r", 3)
          })

          shop.append('svg:polygon')
            .attr("class", "shop")
            .data(coords)
            .attr('opacity', 0.5)
            .attr("fill", data.color)
            .attr("points", coords.join(' '))
            .attr("stroke", data.stroke)
        })

        // Render graph.
        var coords = []
          , graph = svg.append('svg:g').attr('id', 'graph')

        $.each(labels, function(i, label) {
          var a = (Math.round(360 / labels.length) * i) * (Math.PI / 180)
            , x = Math.round(originX + radius * Math.cos(a))
            , y = Math.round(originY + radius * Math.sin(a))

          coords.push([x, y].join(','))

          graph.append('svg:line')
            .attr("class", "graph")
            .attr("x1", originX)
            .attr("y1", originY)
            .attr("x2", x)
            .attr("y2", y)

          for (var n = 0, k = 0; n <= radius; n += (radius / scale), k++) {
            graph.append('svg:circle')
              .attr("class", "dot")
              .attr("cx", Math.round(originX + n * Math.cos(a)))
              .attr("cy", Math.round(originY + n * Math.sin(a)))
              .attr("r", 2)
          }

          var label = graph.append('svg:text')
              .attr("class", "label")
              .attr("x", x)
              .attr("y", y)
              .text(label)

          if (x > width / 2)
            label.attr("dx", 10).attr("dy", 5)
          else
            label.attr("dx", -50).attr("dy", 5)
        });

        graph.append('svg:polygon')
          .data(coords)
          .attr("class", "graph")
          .attr("points", coords.join(' '))
      }

      $(function() {
        $.getJSON("data.php", function(data) {
          if (data && data.success) {
            buildControls(data.shops);
            buildGraph(data.shops);
          }
          else {
            alert('Aww snap.  Error fetching data.');
          }
        });
      })
    </script>

    <!--[if IE]>
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
      <script>
         CFInstall.check({
           mode: "overlay",
           destination: "http://grimhappy.com/coffee"
         });
      </script>
    <![endif]-->
  </body>
</html>

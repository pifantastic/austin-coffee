<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Austin Coffee Shops</title>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/brew.css">
  </head>
  <body>
    <header>
      <h1>Austin Coffee Shops</h1>
    </header>
    <section id="controls"></section>
    <section id="shops"></section>
    <section id="radar"></section>
    <section id="feedback">
      <h3>Am I missing one?  Want to leave your own feedback?</h3>
      <a href="https://docs.google.com/spreadsheet/viewform?formkey=dE9wdU9nT0xLTE8wVm15RFVGRTUxZXc6MQ">Click here!</a>
    </section>
    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/d3.js"></script>
    <script src="js/d3.geom.js"></script>
    <script src="js/radar.js"></script>
    <script>
      $.getJSON('data.php', function(data) {
        if (data.success) {
          var graph = new Radar({
            selector: '#radar',
            width: 600,
            height: 400,
            scale: 5,
            labels: ['taste', 'price', 'wifi', 'hours', 'ambiance']
          });

          $.each(data.shops, function(id, shop) {
            graph.addPolygon(id, shop)

            var div = $('<div class="shop">').attr("data-target", id)
              , h3 = $('<h3>').text(shop.name)
              , link = $('<a>').attr('href', shop.link).text(shop.link)

            div.append(h3).append(link).appendTo('#shops')
          });

          graph.showPolygon($('div.shop:first').addClass('ui-selected').data('target'))

          $('#shops').selectable({
            filter: 'div.shop',
            stop: function(e, ui) {
              console.log(e, ui)
            },
            selected: function(e, ui) {
              graph.showPolygon($(ui.selected).data('target'))
            },
            unselected: function(e, ui) {
              graph.hidePolygon($(ui.unselected).data('target'))
            }
          });

          $(window).keydown(function(e) {
            switch (e.which) {
              case 40: // down
              case 39: // right
                var current = $('div.shop.ui-selected')
                  , next;

                if (!current.length) {
                  graph.showPolygon($('div.shop:first').addClass('ui-selected').data('target'))
                  return
                }

                if (current.length > 1)
                  current = current.last()

                next = current.next()
                if (!next.length)
                  next = $('div.shop:first')

                graph.tween(current.data('target'), next.data('target'))
                current.removeClass('ui-selected')
                next.addClass('ui-selected')
                break;

              case 38: // up
              case 37: // left
                var current = $('div.shop.ui-selected')
                  , prev;

                if (!current.length) {
                  graph.showPolygon($('div.shop:last').addClass('ui-selected').data('target'))
                  return
                }

                if (current.length > 1)
                  current = current.first()

                prev = current.prev()
                if (!prev.length)
                  prev = $('div.shop:last')

                graph.tween(current.data('target'), prev.data('target'))
                current.removeClass('ui-selected')
                prev.addClass('ui-selected')
                break;
                break;
            }
          })
        }
      })

      function buildControls(data) {
        var controls = $('#controls');

        $.each(data, function(id, shop) {
          var checkbox = $('<input type="checkbox" checked="checked"/>')
            .change(function() {
              $('#' + id).toggle($(this).is(':checked'));
            })

          var swatch = $('<span class="swatch" />')
            .css({ backgroundColor: shop.color })

          var link = $('<a />')
            .attr('href', shop.link)
            .text(shop.link)

          $('<label />')
            .text(shop.name + ' | ')
            .prepend(checkbox)
            .prepend(swatch)
            .append(link)
            .appendTo(controls)
        });
      }

      function buildGraph(data) {
        var width = 600
        var height = 400
        var scale = 5
        var points = 5
        var labels = ['taste', 'price', 'wifi', 'hours', 'ambiance']

        var svg = d3.select("#radar")
          .append("svg:svg")
            .attr("width", width)
            .attr("height", height)

        var originX = Math.floor(width / 2)
        var originY = Math.floor(height / 2)
        var radius = Math.floor((width > height ? height : width) / 2)

        // Render data.
        $.each(data, function(id, data) {
          var coords = []
            , shop = svg.append('svg:g').attr("id", id);

          $.each(labels, function(i, attr) {
            var r = Math.round(radius / scale) * data.data[attr]
              , a = (Math.round(360 / labels.length) * i) * (Math.PI / 180)
              , x = Math.round(originX + r * Math.cos(a))
              , y = Math.round(originY + r * Math.sin(a))
            coords.push([x, y].join(','))

            shop.append('svg:circle')
              .attr("class", "dot")
              .attr("cx", x)
              .attr("cy", y)
              .attr("r", 3)
          })

          shop.append('svg:polygon')
            .attr("class", "shop")
            .data(coords)
            .attr('opacity', 0.5)
            .attr("fill", data.color)
            .attr("stroke", data.stroke)
            .attr("points", (new Array(coords.length + 1)).join(originX + ',' + originY + ' '))
            .transition(750)
              .attr("points", coords.join(' '))
        })

        // Render graph.
        var coords = []
          , graph = svg.append('svg:g').attr('id', 'graph')

        $.each(labels, function(i, label) {
          var a = (Math.round(360 / labels.length) * i) * (Math.PI / 180)
            , x = Math.round(originX + radius * Math.cos(a))
            , y = Math.round(originY + radius * Math.sin(a))

          coords.push([x, y].join(','))

          graph.append('svg:line')
            .attr("class", "graph")
            .attr("x1", originX)
            .attr("y1", originY)
            .attr("x2", x)
            .attr("y2", y)

          for (var n = 0, k = 0; n <= radius; n += (radius / scale), k++) {
            graph.append('svg:circle')
              .attr("class", "dot")
              .attr("cx", Math.round(originX + n * Math.cos(a)))
              .attr("cy", Math.round(originY + n * Math.sin(a)))
              .attr("r", 2)
          }

          var label = graph.append('svg:text')
              .attr("class", "label")
              .attr("x", x)
              .attr("y", y)
              .text(label)

          if (x > width / 2)
            label.attr("dx", 10).attr("dy", 5)
          else
            label.attr("dx", -50).attr("dy", 5)
        });

        graph.append('svg:polygon')
          .data(coords)
          .attr("class", "graph")
          .attr("points", coords.join(' '))
      }

      /*
      $(function() {
        $.getJSON("data.php", function(data) {
          if (data && data.success) {
            buildControls(data.shops);
            buildGraph(data.shops);
          }
          else {
            alert('Aww snap.  Error fetching data.');
          }
        });
      })
      */
    </script>

    <!--[if IE]>
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
      <script>
         CFInstall.check({
           mode: "overlay",
           destination: "http://grimhappy.com/coffee"
         });
      </script>
    <![endif]-->
  </body>
</html>
